using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;

namespace PS4_Tools.Util
{
    public class PS4PkgUtil
    {
        static RSAParameters param = new RSAParameters()
        {
            D = new byte[]
            {
                50,
                217,
                3,
                144,
                143,
                189,
                176,
                143,
                87,
                43,
                40,
                94,
                11,
                141,
                179,
                234,
                92,
                209,
                126,
                168,
                144,
                136,
                140,
                221,
                106,
                128,
                187,
                177,
                223,
                193,
                247,
                13,
                170,
                50,
                240,
                183,
                124,
                203,
                136,
                128,
                14,
                139,
                100,
                176,
                190,
                76,
                214,
                14,
                155,
                140,
                30,
                42,
                100,
                225,
                243,
                92,
                215,
                118,
                1,
                65,
                94,
                147,
                92,
                148,
                254,
                221,
                70,
                98,
                195,
                27,
                90,
                226,
                160,
                188,
                45,
                235,
                195,
                152,
                10,
                167,
                183,
                133,
                105,
                112,
                104,
                43,
                100,
                74,
                179,
                31,
                204,
                125,
                220,
                124,
                38,
                244,
                119,
                246,
                92,
                242,
                174,
                90,
                68,
                45,
                211,
                171,
                22,
                98,
                4,
                25,
                186,
                251,
                144,
                byte.MaxValue,
                226,
                48,
                80,
                137,
                110,
                203,
                86,
                178,
                235,
                192,
                145,
                22,
                146,
                94,
                48,
                142,
                174,
                199,
                148,
                93,
                253,
                53,
                225,
                32,
                248,
                173,
                62,
                188,
                8,
                191,
                192,
                54,
                116,
                159,
                213,
                187,
                82,
                8,
                253,
                6,
                102,
                243,
                122,
                179,
                4,
                244,
                117,
                41,
                93,
                233,
                95,
                170,
                16,
                48,
                178,
                15,
                90,
                26,
                193,
                42,
                179,
                254,
                203,
                33,
                173,
                128,
                236,
                143,
                32,
                9,
                28,
                219,
                197,
                88,
                148,
                194,
                156,
                198,
                206,
                130,
                101,
                62,
                87,
                144,
                188,
                169,
                139,
                6,
                180,
                240,
                114,
                246,
                119,
                223,
                152,
                100,
                241,
                236,
                254,
                55,
                45,
                188,
                174,
                140,
                8,
                129,
                31,
                195,
                201,
                137,
                26,
                199,
                66,
                130,
                75,
                46,
                220,
                142,
                141,
                115,
                206,
                177,
                204,
                1,
                217,
                8,
                112,
                135,
                60,
                68,
                8,
                236,
                73,
                143,
                129,
                90,
                226,
                64,
                byte.MaxValue,
                119,
                252,
                13
            },
            DP = new byte[]
            {
                82,
                204,
                45,
                160,
                156,
                158,
                117,
                231,
                40,
                238,
                61,
                222,
                227,
                69,
                209,
                79,
                148,
                28,
                204,
                200,
                135,
                41,
                69,
                59,
                141,
                110,
                171,
                110,
                42,
                167,
                199,
                21,
                67,
                163,
                4,
                143,
                144,
                95,
                235,
                243,
                56,
                74,
                119,
                250,
                54,
                183,
                21,
                118,
                182,
                1,
                26,
                142,
                37,
                135,
                130,
                241,
                85,
                216,
                198,
                67,
                42,
                192,
                229,
                152,
                201,
                50,
                209,
                148,
                111,
                217,
                1,
                186,
                6,
                129,
                224,
                109,
                136,
                242,
                36,
                42,
                37,
                1,
                100,
                92,
                191,
                242,
                217,
                153,
                103,
                62,
                246,
                114,
                238,
                228,
                226,
                51,
                92,
                248,
                0,
                64,
                227,
                42,
                154,
                244,
                61,
                34,
                134,
                68,
                60,
                251,
                10,
                165,
                124,
                63,
                204,
                245,
                241,
                22,
                196,
                172,
                136,
                180,
                222,
                98,
                148,
                146,
                106,
                19
            },
            DQ = new byte[]
            {
                124,
                157,
                173,
                57,
                224,
                213,
                96,
                20,
                148,
                72,
                25,
                127,
                136,
                149,
                213,
                139,
                128,
                173,
                133,
                138,
                75,
                119,
                55,
                133,
                208,
                119,
                187,
                191,
                137,
                113,
                74,
                114,
                203,
                114,
                104,
                56,
                236,
                2,
                198,
                125,
                198,
                68,
                6,
                51,
                81,
                28,
                192,
                byte.MaxValue,
                149,
                143,
                13,
                117,
                220,
                37,
                187,
                11,
                115,
                145,
                169,
                109,
                66,
                216,
                3,
                183,
                104,
                212,
                30,
                117,
                98,
                163,
                112,
                53,
                121,
                120,
                0,
                200,
                245,
                239,
                21,
                185,
                252,
                78,
                71,
                90,
                200,
                112,
                112,
                91,
                82,
                152,
                192,
                194,
                88,
                74,
                112,
                150,
                204,
                184,
                16,
                225,
                47,
                120,
                139,
                43,
                161,
                127,
                249,
                172,
                222,
                240,
                187,
                43,
                226,
                102,
                227,
                34,
                146,
                49,
                33,
                87,
                146,
                196,
                184,
                242,
                62,
                118,
                32,
                55
            },
            Exponent = new byte[]
            {
                0,
                1,
                0,
                1
            },
            InverseQ = new byte[]
            {
                69,
                151,
                85,
                212,
                34,
                8,
                94,
                243,
                92,
                180,
                5,
                122,
                253,
                170,
                66,
                66,
                173,
                154,
                140,
                160,
                108,
                187,
                29,
                104,
                84,
                84,
                110,
                62,
                50,
                227,
                83,
                115,
                118,
                241,
                62,
                1,
                234,
                211,
                207,
                235,
                235,
                35,
                62,
                192,
                190,
                206,
                236,
                44,
                137,
                95,
                168,
                39,
                58,
                76,
                183,
                230,
                116,
                188,
                69,
                76,
                38,
                200,
                37,
                byte.MaxValue,
                52,
                99,
                37,
                55,
                225,
                72,
                16,
                193,
                147,
                166,
                175,
                235,
                186,
                227,
                162,
                241,
                61,
                239,
                99,
                216,
                244,
                253,
                211,
                238,
                226,
                93,
                233,
                51,
                204,
                173,
                186,
                117,
                92,
                133,
                175,
                206,
                169,
                61,
                209,
                162,
                23,
                243,
                246,
                152,
                179,
                80,
                142,
                94,
                246,
                235,
                2,
                142,
                161,
                98,
                167,
                214,
                44,
                236,
                145,
                byte.MaxValue,
                21,
                64,
                210,
                227
            },
            Modulus = new byte[]
            {
                210,
                18,
                252,
                51,
                95,
                109,
                219,
                131,
                22,
                9,
                98,
                139,
                3,
                86,
                39,
                55,
                130,
                212,
                119,
                133,
                53,
                41,
                57,
                45,
                82,
                107,
                140,
                76,
                140,
                251,
                6,
                193,
                132,
                91,
                231,
                212,
                247,
                188,
                210,
                78,
                98,
                69,
                205,
                42,
                187,
                215,
                119,
                118,
                69,
                54,
                85,
                39,
                63,
                179,
                245,
                249,
                142,
                218,
                75,
                239,
                170,
                89,
                174,
                179,
                155,
                234,
                84,
                152,
                210,
                6,
                50,
                106,
                88,
                49,
                42,
                224,
                212,
                79,
                144,
                181,
                10,
                125,
                236,
                244,
                58,
                156,
                82,
                103,
                45,
                153,
                49,
                142,
                12,
                67,
                230,
                130,
                254,
                7,
                70,
                225,
                46,
                80,
                212,
                31,
                45,
                47,
                126,
                217,
                8,
                186,
                6,
                179,
                191,
                46,
                32,
                63,
                78,
                63,
                254,
                68,
                byte.MaxValue,
                170,
                80,
                67,
                87,
                145,
                105,
                148,
                73,
                21,
                130,
                130,
                228,
                15,
                76,
                141,
                157,
                44,
                201,
                91,
                29,
                100,
                191,
                136,
                139,
                212,
                197,
                148,
                231,
                101,
                71,
                132,
                30,
                229,
                121,
                16,
                251,
                152,
                147,
                71,
                185,
                125,
                133,
                18,
                166,
                64,
                152,
                44,
                247,
                146,
                188,
                149,
                25,
                50,
                237,
                232,
                144,
                86,
                13,
                101,
                193,
                170,
                120,
                198,
                46,
                84,
                253,
                95,
                84,
                161,
                246,
                126,
                229,
                224,
                95,
                97,
                193,
                32,
                180,
                185,
                180,
                51,
                8,
                112,
                228,
                223,
                137,
                86,
                237,
                1,
                41,
                70,
                119,
                95,
                140,
                184,
                169,
                245,
                30,
                46,
                179,
                185,
                191,
                224,
                9,
                183,
                141,
                40,
                212,
                166,
                195,
                184,
                30,
                31,
                7,
                235,
                180,
                18,
                11,
                149,
                184,
                133,
                48,
                253,
                220,
                57,
                19,
                208,
                124,
                220,
                143,
                237,
                249,
                201,
                163,
                193
            },
            P = new byte[]
            {
                249,
                103,
                173,
                153,
                18,
                49,
                12,
                86,
                162,
                46,
                22,
                28,
                70,
                179,
                77,
                91,
                67,
                190,
                66,
                162,
                246,
                134,
                150,
                128,
                66,
                195,
                199,
                63,
                195,
                66,
                245,
                135,
                73,
                51,
                159,
                7,
                93,
                110,
                44,
                4,
                253,
                227,
                225,
                178,
                174,
                10,
                12,
                240,
                199,
                166,
                28,
                161,
                99,
                80,
                200,
                9,
                156,
                81,
                36,
                82,
                108,
                94,
                94,
                189,
                30,
                39,
                6,
                187,
                188,
                158,
                148,
                225,
                53,
                212,
                109,
                179,
                203,
                60,
                104,
                221,
                104,
                179,
                254,
                108,
                203,
                141,
                130,
                32,
                118,
                35,
                99,
                183,
                233,
                104,
                16,
                1,
                78,
                220,
                186,
                39,
                93,
                1,
                193,
                45,
                128,
                94,
                43,
                175,
                130,
                107,
                216,
                132,
                182,
                16,
                82,
                134,
                167,
                137,
                142,
                174,
                154,
                226,
                137,
                198,
                247,
                213,
                135,
                251
            },
            Q = new byte[]
            {
                215,
                161,
                15,
                154,
                139,
                242,
                201,
                17,
                149,
                50,
                154,
                140,
                240,
                217,
                64,
                71,
                245,
                104,
                160,
                13,
                189,
                193,
                252,
                67,
                47,
                101,
                249,
                195,
                97,
                15,
                37,
                119,
                84,
                173,
                215,
                88,
                172,
                132,
                64,
                96,
                141,
                63,
                243,
                101,
                137,
                117,
                181,
                198,
                44,
                81,
                26,
                47,
                31,
                34,
                228,
                67,
                17,
                84,
                190,
                201,
                180,
                199,
                181,
                27,
                5,
                11,
                188,
                86,
                154,
                205,
                74,
                217,
                115,
                104,
                94,
                92,
                251,
                146,
                183,
                139,
                13,
                byte.MaxValue,
                245,
                7,
                202,
                180,
                200,
                155,
                150,
                60,
                7,
                158,
                62,
                107,
                42,
                17,
                242,
                138,
                177,
                138,
                215,
                46,
                27,
                165,
                83,
                36,
                6,
                237,
                80,
                184,
                144,
                103,
                177,
                226,
                65,
                198,
                146,
                1,
                238,
                16,
                240,
                97,
                187,
                251,
                178,
                125,
                74,
                115
            }
        };

        public struct PackageEntry
        {
            public uint id;//this is the ID of the PKG Item
            public uint filename_offset;//Filename Offset
            public uint flags1;
            public uint flags2;
            public uint offset;
            public uint size;//size of entry
            public byte[] padding;

            public uint key_index;//key index
            public bool is_encrypted;//is encrypted

            //public byte[] ReverseAndGetBytes(object item)
            //{
            //    byte[] rtnitem = BitConverter.GetBytes(item);
            //    Array.Reverse(rtnitem);
            //    return rtnitem;
            //}

            public byte[] ToArray()
            {
                MemoryStream ms = new MemoryStream();
                BinaryWriter writer = new BinaryWriter(ms, Encoding.BigEndianUnicode);
                //writer.Write();
                byte[] item = BitConverter.GetBytes(this.filename_offset);
                Array.Reverse(item);
                writer.Write(item);
                writer.Write(this.flags1);
                writer.Write(this.flags2);
                writer.Write(this.offset);
                writer.Write(this.size);
                writer.Write(this.padding);
                writer.Close();
                return ms.ToArray();
            }

            //public byte[] ToArray()
            //{
            //    var ms = new MemoryStream();
            //    var writer = new EndianWriter(ms, EndianType.BigEndian);

            //    writer.Write(type);
            //    writer.Write(unk1);
            //    writer.Write(flags1);
            //    writer.Write(flags2);
            //    writer.Write(offset);
            //    writer.Write(size);
            //    writer.Write(padding);

            //    writer.Close();

            //    return ms.ToArray();
            //}
        };

        public static byte[] Decrypt(byte[] data)
        {
            using (var rsa = new RSACryptoServiceProvider(2048))
            {
                // Import the RSA key information.
                // This needs to include private key information.
                rsa.ImportParameters(param);
                return rsa.Decrypt(data, false);
            }
        }

        public byte[] Encrypt(byte[] data)
        {
            using (var rsa = new RSACryptoServiceProvider(2048))
            {
                rsa.ImportParameters(param);
                return rsa.Encrypt(data, false);
            }
        }
    }
}
